import pandas as pd
import matplotlib.pyplot as plt

# 1. Load the 311 Dataset
df = pd.read_csv('ODC_service_requests_311_8405769495820686528.csv')

# 2. Filter for Encampment & Sweep specific case types
target_summaries = [
    'Encampment Reporting', 
    '911 ENCAMPMENT', 
    'Homeless Encampments',
    'Encampment / Street Engagement',
    'Sweep Request',
    'Request to Begin Sweeping'
]
df_filtered = df[df['Case Summary'].isin(target_summaries)].copy()

# 3. Clean Dates and Group by Month
df_filtered['Date'] = pd.to_datetime(df_filtered['Case Created Date'])
df_filtered = df_filtered.dropna(subset=['Date'])
df_filtered['YearMonth'] = df_filtered['Date'].dt.to_period('M')

# 4. Aggregate
monthly_counts = df_filtered.groupby('YearMonth').size().reset_index(name='Encampment_Reports')

# Save the clean data to CSV for the site
monthly_counts.to_csv('encampment_reports_monthly.csv', index=False)

# 5. Build the Sabin Health Chart
plt.figure(figsize=(10, 6))

# Remove the incomplete Feb 2026 data point for clean charting
plot_data = monthly_counts[monthly_counts['YearMonth'] < '2026-02'].copy()
plot_data['DateObj'] = plot_data['YearMonth'].dt.to_timestamp()

# Dual overlay: Bar chart for volume + Line chart for trend (Sabin Colors)
plt.bar(plot_data['DateObj'], plot_data['Encampment_Reports'], color='#bdc3c7', alpha=0.4, width=20)
plt.plot(plot_data['DateObj'], plot_data['Encampment_Reports'], marker='o', color='#c0392b', linewidth=3, label='311 Encampment Reports')

plt.title('Denver 311 Reports: Homeless Encampments & Sweeps (2025 - 2026)', fontsize=14, color='#2c3e50', pad=15)
plt.ylabel('Number of Citizen Reports', fontweight='bold', color='#2c3e50')
plt.xlabel('Month', fontweight='bold', color='#2c3e50')
plt.xticks(rotation=45)
plt.grid(axis='y', linestyle='--', alpha=0.7)

plt.tight_layout()
plt.savefig('encampment_reports_trend.png')
